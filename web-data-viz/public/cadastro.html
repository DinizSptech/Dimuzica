<!DOCTYPE html>
<script src="./main.js"></script>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dimuzica</title>
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="./assets/logo.ico" type="image/x-icon">
  <script src="./js/sessao.js"></script>
</head>
<body>
  <div class="header">
    <div class="botaolegal">
      <div class="login_button" onclick="local_login()">Login</div>
      <div class="cadastro_button" onclick="local_cadastro()">Cadastro</div>
    </div>
  </div>
  <div class="container">
    
    <div class="alerta_erro">
      <div class="card_erro" id="cardErro">
        <span id="mensagem_erro"></span>
      </div>
    </div>
    <div class="info genero">
      <input type="checkbox" id="checkRock" class="textobox" oninput="Deci()"><label class="" for="checkRock" onclick="Deci()">Rock clássico</label> |
      <input type="checkbox" id="checkAlternativo" class="textobox" oninput="Octo()"><label class="" for="chk8" onclick="Octo()">Rock alternativo</label> |
      <input type="checkbox" id="checkMetal" class="textobox" oninput="Bi()"><label class="" for="checkMetal" onclick="Bi()">Binario</label> |
      <button class="botao cadastro">Escolher genero</button>
    </div>

    <div id="pos_genero">

      <div class="info">
        <div class="input_holder">
          Usuario
          <input type="text" id="user_input" class="input">
        </div>
        <div class="input_holder">
          Email
          <input type="text" id="email_input" class="input">
        </div>
        <div class="input_holder">  
          Senha
          <input type="password" id="senha_input" class="input">
        </div>
        <div class="input_holder">  
          Confirme a sua senha
          <input type="password" id="confirmacao_senha_input" class="input">
        </div>
        <button class="botao cadastro" onclick="cadastrar()">Cadastrar</button>
        <div id="div_aguardar" class="loading-div">
          <img src="./assets/circle-loading.gif" id="loading-gif">
        </div>
      </div>
    </div>

  </div>
  </body>
  <script>
        var rock = document.getElementById("checkRock")
        var alternativo = document.getElementById("checkIndie")
        var metal = document.getElementById("checkMetal")
        var base
        function Bi(){
        base = 'rock'
        indie.checked = false;
        experimental.checked = false;
        metal.checked = false;
    }
    function Deci(){
        base = 'indie'
        rock.checked = false;
        metal.checked = false;
    }
    function Octo(){
        base = 'experimental'
        rock.checked = false;
        metal.checked = false;
        }
        function metal(){
        base = 'metal'
        rock.checked = false;
        alternativo.checked = false;
        }
  // Array para armazenar empresas cadastradas para validação de código de ativação 
  // let listaEmpresasCadastradas = [];
    var genero = null
  function selecionar(){
    if(genero == null){
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "As duas senhas devem ser iguais";
      finalizarAguardar();
      return false;
    }
  }

  function cadastrar() {
    // aguardar();

    //Recupere o valor da nova input pelo user do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = user_input.value;
    var emailVar = email_input.value;
    var senhaVar = senha_input.value;
    var confirmacaoSenhaVar = confirmacao_senha_input.value;
    var idEmpresaVincular

    // Verificando se há algum campo em branco
    if (
      nomeVar == "" ||
      emailVar == "" ||
      senhaVar == "" ||
      confirmacaoSenhaVar == "" 
    ) {
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "(Preencha todos os campos)";

      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    var validar = '!@#$%&*()'
    var inclui$User = false
    var inclui$enha = false
    for(var i = 0; i < validar.length && (inclui$User == false || inclui$enha == false); i++){
      if(nomeVar.includes(validar[i])){
        inclui$User = true
      }
      if(senhaVar.includes(validar[i])){
        inclui$enha = true
      }
    }


    if (nomeVar.length > 30){
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "O nome deve ter menos de 30 caracteres";

      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    if (inclui$User){
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "O nome não pode ter caracteres especiais";

      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    if (senhaVar.length < 8){
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "A senha deve ter mais de 7 caracteres";

      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    if (!inclui$enha){
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "A senha deve ter pelo menos 1 caracter especial";
      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    if (senhaVar != confirmacaoSenhaVar){
      cardErro.style.display = "block";
      mensagem_erro.innerHTML =
        "As duas senhas devem ser iguais";
      finalizarAguardar();
      return false;
    } else {
      setInterval(sumirMensagem, 5000);
    }

    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        nomeServer: nomeVar,
        emailServer: emailVar,
        senhaServer: senhaVar
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          cardErro.style.display = "block";

          mensagem_erro.innerHTML =
            "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

          setTimeout(() => {
            window.location = "login.html";
          }, "2000");

          limparFormulario();
          finalizarAguardar();
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });

    return false;
  }

  // Listando empresas cadastradas 
  function listar() {
    fetch("/empresas/listar", {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((empresas) => {
          empresas.forEach((empresa) => {
            listaEmpresasCadastradas.push(empresa);

            console.log("listaEmpresasCadastradas")
            console.log(listaEmpresasCadastradas[0].codigo_ativacao)
          });
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function sumirMensagem() {
    cardErro.style.display = "none";
  }
</script>
